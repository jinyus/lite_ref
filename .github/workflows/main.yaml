name: Dart Test

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
    workflow_dispatch:
    pull_request:
        branches: ["main"]
        types: [ready_for_review, review_requested] # Restrict to non-draft PRs

jobs:
    spell-check:
        uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/spell_check.yml@v1
        with:
            includes: "*.md"
            modified_files_only: true

    build:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“š Git Checkout
              uses: actions/checkout@v4

            - name: ğŸ¯ Setup Dart
              uses: dart-lang/setup-dart@v1

            - name: ğŸ“¦ Install Dependencies
              run: dart pub get

            - name: âœ¨ Check Formatting
              run: dart format --set-exit-if-changed .

            - name: ğŸ•µï¸ Analyze
              run: dart analyze --fatal-infos --fatal-warnings lib test

            - name: ğŸ§ª Run Tests
              run: |
                  dart pub global activate coverage 1.2.0
                  dart test -j 4 --coverage=coverage && dart pub global run coverage:format_coverage --lcov --in=coverage --out=coverage/lcov.info

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@v3
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
              with:
                  files: ./coverage/lcov.info
                  flags: unittests
